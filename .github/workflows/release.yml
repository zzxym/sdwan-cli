name: EasyTier Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'EasyTier ç‰ˆæœ¬å·'
        type: string
        default: 'v2.4.3'
        required: true
      make_latest:
        description: 'æ ‡è®°ä¸ºæœ€æ–°ç‰ˆæœ¬'
        type: boolean
        default: true
        required: true

permissions:
  contents: write

jobs:
  release:
    if: contains('["zzxym"]', github.actor)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # åˆ›å»ºä¸‹è½½ç›®å½•
      - name: Create download directory
        run: mkdir -p release_assets

      # ğŸ‰ è§£å†³æ–¹æ¡ˆï¼šæ·»åŠ  PAT (Personal Access Token) è®¤è¯
      # ä½¿ç”¨å·²è®¤è¯è¯·æ±‚ç›´æ¥ä¸‹è½½ Release èµ„äº§
      - name: Download Release Assets
        run: |
          RELEASE_URL="https://api.github.com/repos/EasyTier/EasyTier/releases/tags/$VERSION"
          ASSETS_URL=$(curl -sH "Authorization: token ${{ secrets.EASYTIER_TOKEN }}" $RELEASE_URL | jq -r '.assets[].browser_download_url')
          
          for url in $ASSETS_URL; do
            filename=$(echo $url | grep -o '[^/]*$')
            echo "æ­£åœ¨ä¸‹è½½: $filename"
            curl -sL -H "Authorization: token ${{ secrets.EASYTIER_TOKEN }}" $url -o "release_assets/$filename"
          done
        env:
          VERSION: ${{ inputs.version }}
          
      # é‡å‘½åæ–‡ä»¶æ·»åŠ ç‰ˆæœ¬å·
      - name: Rename assets with version
        run: |
          cd release_assets
          for f in *; do
            # è¿‡æ»¤æ‰å·²ç»åŒ…å«ç‰ˆæœ¬å·çš„æ–‡ä»¶å
            if [[ ! "$f" =~ -v?[0-9]+\.[0-9]+\.[0-9]+ ]]; then
              ext="${f##*.}"
              name="${f%.*}"
              mv "$f" "$name-$VERSION.$ext"
            fi
          done
        env:
          VERSION: ${{ inputs.version }}
          
      # ç‰¹æ®Šå¤„ç† Magisk åŒ…
      - name: Process Magisk Asset
        run: |
          MAGISK_ASSET=$(find release_assets -type f -iname "easytier-magisk*$VERSION*")
          
          # ç¡®ä¿æ‰¾åˆ°æ–‡ä»¶ä¸”ä»…æœ‰ä¸€ä¸ª
          if [[ -n "$MAGISK_ASSET" ]]; then
            # Magisk åŒ…å†…éƒ¨ç»“æ„
            mkdir -p magisk_temp
            unzip -q "$MAGISK_ASSET" -d magisk_temp/
            
            # æ¸…ç†åŸæ–‡ä»¶å¹¶é‡æ–°å‹ç¼©ä¸ºæ ‡å‡†æ ¼å¼
            rm "$MAGISK_ASSET"
            cd magisk_temp
            zip -r "../release_assets/Easytier-Magisk-$VERSION.zip" .
            cd ..
            rm -rf magisk_temp
          else
            echo "âš ï¸ Warning: Magisk æ–‡ä»¶æœªæ‰¾åˆ°! è·³è¿‡å¤„ç†."
          fi
        env:
          VERSION: ${{ inputs.version }}

      # åˆ›å»ºå‘å¸ƒ
      - name: Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ inputs.version }}
          draft: true
          files: |
            release_assets/*
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ inputs.version }}
          make_latest: ${{ inputs.make_latest }}
